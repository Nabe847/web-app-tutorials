---
title: '2: 画面とWeb APIの連携'
pubDate: 2024-03-20
description: 'フロントエンドとバックエンドを連携させます'
author: 'Nabe847'
image:
  url: 'https://docs.astro.build/assets/full-logo-light.png'
  alt: 'フルスタックアプリケーションのロゴ。'
tags: ['Next.js', 'FastAPI', 'tutorial']
---

## このステップについて

このステップでは、フロントエンド（画面）とバックエンド（サーバー）を連携させます。これにより、画面からデータの保存や取得ができるようになります。

## CORSの設定

### CORSとは？

CORS（Cross-Origin Resource Sharing）は、**異なるWebサイト間での通信を許可するかどうかを制御する仕組み**です。

例えば：
- フロントエンド（`http://localhost:3000`）から
- バックエンド（`http://localhost:8000`）のAPIを呼び出す

この場合、バックエンド側で「`http://localhost:3000`からのアクセスを許可する」と設定する必要があります。

### CORSの設定方法

`app/main.py`を編集して、CORSの設定を追加します：

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

# CORSの設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # フロントエンドのURL
    allow_credentials=True,
    allow_methods=["*"],  # すべてのHTTPメソッドを許可
    allow_headers=["*"],  # すべてのヘッダーを許可
)

# 既存のエンドポイントはそのまま使用
```

1. バックエンドサーバーを再起動します：

```bash
cd todo-manager-backend
uvicorn app.main:app --reload
```

2. ブラウザで `http://localhost:8000/docs` を開き、Swagger UIが表示されることを確認します。

## APIクライアントの作成

### APIとは？

API（Application Programming Interface）は、**プログラム同士が通信するための約束事**です。この場合、フロントエンドとバックエンドがデータをやり取りするための方法を定義します。

### APIクライアントの実装

`src/lib/api.js`を作成します：

```javascript
const API_URL = 'http://localhost:8000';

export const api = {
  // Todo一覧の取得
  async getTodos() {
    const response = await fetch(`${API_URL}/todos`);
    if (!response.ok) throw new Error('Todoの取得に失敗しました');
    return response.json();
  },

  // 新しいTodoの作成
  async createTodo(title) {
    const response = await fetch(`${API_URL}/todos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title }),
    });
    if (!response.ok) throw new Error('Todoの作成に失敗しました');
    return response.json();
  },

  // Todoの更新
  async updateTodo(id, todo) {
    const response = await fetch(`${API_URL}/todos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(todo),
    });
    if (!response.ok) throw new Error('Todoの更新に失敗しました');
    return response.json();
  },

  // Todoの削除
  async deleteTodo(id) {
    const response = await fetch(`${API_URL}/todos/${id}`, {
      method: 'DELETE',
    });
    if (!response.ok) throw new Error('Todoの削除に失敗しました');
  },
};
```

### 動作確認

1. バックエンドサーバーが起動していることを確認：

```bash
cd todo-manager-backend
uvicorn app.main:app --reload
```

2. フロントエンドサーバーが起動していることを確認：

```bash
cd todo-manager-frontend
npm run dev
```

3. ブラウザの開発者ツール（F12）を開き、「Console」タブで以下を実行：

```javascript
// APIクライアントのテスト
const test = async () => {
  try {
    // Todoの作成
    const todo = await api.createTodo('テストTodo');
    console.log('作成したTodo:', todo);

    // Todo一覧の取得
    const todos = await api.getTodos();
    console.log('Todo一覧:', todos);

    // Todoの更新
    const updatedTodo = await api.updateTodo(todo.id, {
      ...todo,
      completed: true,
    });
    console.log('更新したTodo:', updatedTodo);

    // Todoの削除
    await api.deleteTodo(todo.id);
    console.log('Todoを削除しました');
  } catch (error) {
    console.error('エラー:', error);
  }
};

test();
```

## よくある問題と解決方法

**CORSエラーが発生する場合**

- エラーメッセージ例：`Access to fetch at 'http://localhost:8000/todos' from origin 'http://localhost:3000' has been blocked by CORS policy`
- 解決方法：
  1. `app/main.py` のCORS設定を確認
  2. フロントエンドのURLが正しく設定されているか確認
  3. バックエンドサーバーを再起動

**APIリクエストが失敗する場合**

- エラーメッセージ例：`Failed to fetch`
- 解決方法：
  1. バックエンドサーバーが起動しているか確認
  2. `API_URL`が正しいか確認
  3. CORSの設定が正しいか確認

## 次のステップ

これでフロントエンドとバックエンドの連携は完了です。次のステップでは、アプリケーションの動作確認を行います。
