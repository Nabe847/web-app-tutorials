---
title: '3: データベースの設定'
pubDate: 2024-03-20
description: 'SQLiteデータベースの設定とTodoモデルの作成を行います'
author: 'Nabe847'
image:
  url: 'https://docs.astro.build/assets/full-logo-light.png'
  alt: 'FastAPIのロゴ。'
tags: ['FastAPI', 'tutorial']
---

## データベースの設定

まず、SQLiteデータベースの設定を行います。`app/database.py` を以下のように編集します：

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# SQLiteデータベースのURL
SQLALCHEMY_DATABASE_URL = "sqlite:///./todo.db"

# データベースエンジンの作成
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)

# セッションの作成
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# モデルのベースクラス
Base = declarative_base()

# データベースセッションを取得する関数
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

> 💡 **SQLite**: 軽量なデータベースです。ファイルベースで動作するため、設定が簡単です。
> 💡 **SQLAlchemy**: Pythonでデータベースを操作するためのライブラリです。

## Todoモデルの作成

次に、Todoのデータモデルを作成します。`app/models.py` を以下のように編集します：

```python
from sqlalchemy import Column, Integer, String, Boolean
from .database import Base

class Todo(Base):
    __tablename__ = "todos"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String, index=True)
    completed = Column(Boolean, default=False)
```

> 💡 **モデル**: データベースのテーブルの構造を定義するクラスです。
> 💡 **カラム**: テーブルの列を表します。以下のカラムを定義しました：
> - `id`: Todoの一意の識別子
> - `title`: Todoのタイトル
> - `completed`: 完了状態（True/False）

## データベースの初期化

データベースとテーブルを作成するために、`app/main.py` を以下のように更新します：

```python
from fastapi import FastAPI
from . import models
from .database import engine

# データベースのテーブルを作成
models.Base.metadata.create_all(bind=engine)

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello World"}
```

## 動作確認

サーバーを再起動して、データベースが正しく作成されたか確認しましょう：

1. サーバーを停止（Ctrl+C）して、再度起動します：
```bash
uvicorn app.main:app --reload
```

2. `todo.db` ファイルが作成されていることを確認します：
```bash
ls todo.db
```

> 💡 **データベースファイル**: `todo.db` というファイルが作成されます。これがSQLiteデータベースの実体です。

## よくある問題と解決方法

**データベースファイルが作成されない場合**

- エラーメッセージ例：`sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) unable to open database file`
- 解決方法：
  1. アプリケーションの実行権限を確認
  2. フォルダの書き込み権限を確認
  3. 絶対パスを使用してデータベースURLを指定

**テーブルが作成されない場合**

- エラーメッセージ例：`sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) table todos already exists`
- 解決方法：
  1. データベースファイルを削除して再作成
  2. マイグレーションツールを使用して管理

## 次のステップ

これでデータベースの設定とTodoモデルの作成が完了しました。次のステップでは、TodoのCRUD機能を実装していきます。 