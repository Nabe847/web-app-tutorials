---
title: '8: ã‚¨ãƒ©ãƒ¼å‡¦ç†'
pubDate: 2025-06-09
description: 'FastAPI ã®åˆå¿ƒè€…å‘ã‘ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã™'
author: 'Nabe847'
image:
  url: 'https://docs.astro.build/assets/full-logo-light.png'
  alt: 'FastAPIã®ãƒ­ã‚´ã€‚'
tags: ['FastAPI', 'tutorial']
---

## ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å­¦ã¶ã“ã¨

å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ç¶šã„ã¦ã€ä»Šå›ã¯APIã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æ”¹å–„ã—ã¾ã™ã€‚  
ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã—ã€APIã®ä½¿ã„ã‚„ã™ã•ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚

1. **ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®ä½œæˆ**
2. **ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè£…**
3. **å‹•ä½œç¢ºèª**

> ğŸ’¡ **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: APIã§ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã“ã¨ã§ã™ã€‚

## ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„

ã‚ˆã‚Šè‰¯ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã€ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚`app/exceptions.py` ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™:

```python
# app/exceptions.py

from fastapi import HTTPException, status

class TodoNotFoundError(HTTPException):
    def __init__(self):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="æŒ‡å®šã•ã‚ŒãŸTodoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        )

class InvalidTodoDataError(HTTPException):
    def __init__(self, detail: str):
        super().__init__(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=detail
        )
```

`app/main.py` ã‚’æ›´æ–°ã—ã€æ–°ã—ã„ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã„ã¾ã™:

```python
# app/main.py

from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from . import models, schemas, exceptions
from .database import engine, get_db

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
models.Base.metadata.create_all(bind=engine)

app = FastAPI()

# Todoã®ä½œæˆ
@app.post("/todos/", response_model=schemas.Todo)
def create_todo(todo: schemas.TodoCreate, db: Session = Depends(get_db)):
    # ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if not todo.title.strip():
        raise exceptions.InvalidTodoDataError("ã‚¿ã‚¤ãƒˆãƒ«ã¯ç©ºã«ã§ãã¾ã›ã‚“")
    
    # Todoã‚’ä½œæˆ
    db_todo = models.Todo(title=todo.title)
    db.add(db_todo)
    db.commit()
    db.refresh(db_todo)
    return db_todo

# Todoã®ä¸€è¦§å–å¾—
@app.get("/todos/", response_model=list[schemas.Todo])
def read_todos(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    todos = db.query(models.Todo).offset(skip).limit(limit).all()
    return todos

# ç‰¹å®šã®Todoã®å–å¾—
@app.get("/todos/{todo_id}", response_model=schemas.Todo)
def read_todo(todo_id: int, db: Session = Depends(get_db)):
    db_todo = db.query(models.Todo).filter(models.Todo.id == todo_id).first()
    if db_todo is None:
        raise exceptions.TodoNotFoundError()
    return db_todo

# Todoã®æ›´æ–°
@app.put("/todos/{todo_id}", response_model=schemas.Todo)
def update_todo(todo_id: int, todo: schemas.TodoCreate, db: Session = Depends(get_db)):
    # ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if not todo.title.strip():
        raise exceptions.InvalidTodoDataError("ã‚¿ã‚¤ãƒˆãƒ«ã¯ç©ºã«ã§ãã¾ã›ã‚“")
    
    # Todoã‚’å–å¾—
    db_todo = db.query(models.Todo).filter(models.Todo.id == todo_id).first()
    if db_todo is None:
        raise exceptions.TodoNotFoundError()
    
    # Todoã‚’æ›´æ–°
    db_todo.title = todo.title
    db.commit()
    db.refresh(db_todo)
    return db_todo

# Todoã®å®Œäº†çŠ¶æ…‹ã®æ›´æ–°
@app.patch("/todos/{todo_id}/complete", response_model=schemas.Todo)
def complete_todo(todo_id: int, db: Session = Depends(get_db)):
    # Todoã‚’å–å¾—
    db_todo = db.query(models.Todo).filter(models.Todo.id == todo_id).first()
    if db_todo is None:
        raise exceptions.TodoNotFoundError()
    
    # Todoã‚’å®Œäº†çŠ¶æ…‹ã«æ›´æ–°
    db_todo.completed = True
    db.commit()
    db.refresh(db_todo)
    return db_todo

# Todoã®å‰Šé™¤
@app.delete("/todos/{todo_id}")
def delete_todo(todo_id: int, db: Session = Depends(get_db)):
    # Todoã‚’å–å¾—
    db_todo = db.query(models.Todo).filter(models.Todo.id == todo_id).first()
    if db_todo is None:
        raise exceptions.TodoNotFoundError()
    
    # Todoã‚’å‰Šé™¤
    db.delete(db_todo)
    db.commit()
    return {"message": "Todoã‚’å‰Šé™¤ã—ã¾ã—ãŸ"}
```

## ã‚³ãƒ¼ãƒ‰ã®è§£èª¬

1. **ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹**

   ```python
   class TodoNotFoundError(HTTPException):
       def __init__(self):
           super().__init__(
               status_code=status.HTTP_404_NOT_FOUND,
               detail="æŒ‡å®šã•ã‚ŒãŸTodoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
           )
   ```

   - `HTTPException`ã‚’ç¶™æ‰¿ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™
   - `status_code`: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¾ã™
   - `detail`: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™

2. **ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè£…**

   ```python
   if not todo.title.strip():
       raise exceptions.InvalidTodoDataError("ã‚¿ã‚¤ãƒˆãƒ«ã¯ç©ºã«ã§ãã¾ã›ã‚“")
   ```

   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
   - ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¾ã™

## ğŸš€ å‹•ä½œç¢ºèª

APIã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†:

1. å­˜åœ¨ã—ãªã„Todoã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹:
```bash
curl http://localhost:8000/todos/999
```
æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
```json
{
  "detail": "æŒ‡å®šã•ã‚ŒãŸTodoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
}
```

2. ç©ºã®ã‚¿ã‚¤ãƒˆãƒ«ã§Todoã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹:
```bash
curl -X POST http://localhost:8000/todos/ -H "Content-Type: application/json" -d '{"title": ""}'
```
æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
```json
{
  "detail": "ã‚¿ã‚¤ãƒˆãƒ«ã¯ç©ºã«ã§ãã¾ã›ã‚“"
}
```

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆ**

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹: `Internal Server Error`
- è§£æ±ºæ–¹æ³•:
  1. ãƒ­ã‚°ã‚’ç¢ºèª
  2. ä¾‹å¤–å‡¦ç†ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  3. ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹

**ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆ**

- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹: `NameError: name 'exceptions' is not defined`
- è§£æ±ºæ–¹æ³•:
  1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒæ­£ã—ã„ã‹ç¢ºèª
  2. ä¾‹å¤–ã‚¯ãƒ©ã‚¹ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ğŸ¯ ç†è§£åº¦ãƒã‚§ãƒƒã‚¯

ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã¦ã€å­¦ç¿’å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼

1. **FastAPIã§ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã®æ­£ã—ã„æ›¸ãæ–¹ã¯ï¼Ÿ**

   - A: `class CustomError(HTTPException):`
   - B: `class CustomError(Exception):`
   - C: `class CustomError:`

<details>
<summary>ç­”ãˆã‚’è¦‹ã‚‹</summary>

   **ç­”ãˆ: A: `class CustomError(HTTPException):`**

   - FastAPIã§ã¯`HTTPException`ã‚’ç¶™æ‰¿ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™
   - `HTTPException`ã‚’ç¶™æ‰¿ã™ã‚‹ã“ã¨ã§ã€FastAPIã®ã‚¨ãƒ©ãƒ¼å‡¦ç†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã™
   - å‚è€ƒ: [FastAPIå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://fastapi.tiangolo.com/tutorial/handling-errors/)
</details>

## ğŸ“ ã¾ã¨ã‚

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ä»¥ä¸‹ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚

- **ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„**
  - ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®ä½œæˆæ–¹æ³•
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•
  - ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè£…æ–¹æ³•
- **APIã®ä½¿ã„ã‚„ã™ã•å‘ä¸Š**
  - åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æä¾›
  - é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä½¿ç”¨
  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
- **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã®å¯¾å‡¦æ³•
  - ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã®å¯¾å‡¦æ³•

--- 